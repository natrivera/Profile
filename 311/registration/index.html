<!DOCTYPE html>
<html lang="en">

<head>
    <title>Registration Page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../style.css">
  <script src="../nav.js"></script>	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.18.min.js"></script>
    <script id="facebook-jssdk" src="https://connect.facebook.net/en_US/all.js"></script>
  

  
</head>

<body>

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="../">Home</a>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#headlinks">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <div class="nav navbar-nav navbar-collapse collapse" id="headlinks">
                <ul class="nav navbar-nav" id="navlist">
                    <li><a href="../login">Login</a></li>
                    <li><a href="../about">About</a></li>
                    <li><a href="../contact">Contact</a></li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="../registration">Registration</a></li>
                            <li><a href="../profile">Profile</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <h1>Registration Page</h1>
        <div id="alerts"></div>

        <div id="userForm" class="displaydiv">

            <div>
                <label>Full Name:</label>
                <br>
                <input type="text" class="form-control" id="fullName">
                <br>
                <label>E-mail:</label>
                <br>
                <input type="text" class="form-control" id="email">
                <br>
            </div>
            <button id="submit" class="btn btn-success">Submit</button>

        </div>


        <div id="addimg" style="display: none;" class="displaydiv">
            <input type="file" id="file-chooser" />
            <br><br>
            <button class="btn btn-success" id="upload-button" >Upload profile image</button>
        </div>

        <div id="profileLink" style="display: none;" class="displaydiv">
            <h3>Your account has been created and image was uploaded...</h3>
            <br>
        </div>

    </div>	
    <script type="text/javascript">
    var fbUserId;
    var params;
    var fullName;
    
    var email;
    var dynamodb = null;
    var docClient = null;
    var appId = '2045270475694111'; //from facebook
    var roleArn = 'arn:aws:iam::900320608260:role/micro8'; //from AWS IAM
    var resultData = null;
    var bucketName = 'micro8'; //CHANGE TO YOUR S3 BUCKET NAME
    var bucket;
    var username;
        

    var fileChooser = document.getElementById('file-chooser');
    var button = document.getElementById('upload-button');
    



        //analyze and output the url parameters as a useful array to caller, based upon http://stackoverflow.com/a/26434126
        function breakUpURLParameters(url) {
            //  create a link in the DOM and set its href
            var link = document.createElement('a');
            link.setAttribute('href', url);
            console.log("path variable is " + url);

            //  return an easy-to-use object that breaks apart the path
            return {
                host: link.hostname,  //  'example.com'
                port: link.port,      //  12345
                search: mapMaker(link.search),  //  {startIndex: 1, pageSize: 10}
                path: link.pathname,  //  '/blog/foo/bar'
                protocol: link.protocol   //  'http:'
            }
        }

        function mapMaker(search, preserveDuplicates) {
            //  option to preserve duplicate keys (e.g. 'sort=name&sort=age')
            preserveDuplicates = preserveDuplicates || false;  //  disabled by default

            var outputNoDupes = {};
            var returnableArray = [];  //  optional output array to preserve duplicate keys

            //  sanity check
            if (!search) throw new Error('mapMaker: your search input param is misformed?');

            //  remove ? character from your url (?foo=1&bar=2 -> 'foo=1&bar=2')
            search = search.split('?')[1];

            //  split apart your keys into a useful array of key/value pairs ('foo=1&bar=2' -> ['foo=1', 'bar=2'])
            search = search.split('&');

            //  separate keys from values (['foo=1', 'bar=2'] -> [{foo:1}, {bar:2}])
            //  then package as an array for your caller to use as variables
            returnableArray = search.map(function (keyval) {
                var out = {};
                keyval = keyval.split('=');
                out[keyval[0]] = keyval[1];
                outputNoDupes[keyval[0]] = keyval[1]; //  might as well do the no-dupe work too while we're in the loop
                return out;
            });

            return (preserveDuplicates) ? returnableArray : outputNoDupes;
        }//end of mapmaker

        document.getElementById('submit').onclick = function () {
        
        dynamodb = new AWS.DynamoDB({ region: 'us-west-2' });
        docClient = new AWS.DynamoDB.DocumentClient({ service: dynamodb });
        fullName = document.getElementById("fullName").value;
        email = document.getElementById("email").value;
        console.log("Full name: ", fullName);
        console.log("E-mail: ", email);
        params = {
            TableName: 'micro8table',
            Item: {
                itemID: fullName,
                sortKey: 'new',
                email_: email
            }
        };
        docClient.put(params, function (err, data) {
            if (err) console.log(err);
            else {
                resultData = data;
                console.log(resultData);
                document.getElementById("userForm").style.display = "none";
                document.getElementById("addimg").style.display = "block";

            }
        })


        };

        button.addEventListener('click', function () {
            var file = fileChooser.files[0];
            if (file) {
                
                //Object key will be facebook-USERID#/FILE_NAME
                var objKey = 'facebook-' + fbUserId + '/' + file.name;
                var params = {
                    Key: objKey,
                    ContentType: file.type,
                    Body: file,
                    ACL: 'public-read'
                };
                bucket.putObject(params, function (err, data) {
                    if (err) {

                        console.log("Your file did not load");
                    } else {

                        console.log("Your file was loaded...");


                        params = {
                            TableName: 'micro8table',
                            Key: {
                                itemID: fullName,
                                sortKey: 'new'

                            },
                            ExpressionAttributeNames: {
                                '#a': 'imgurl'
                            },
                            ExpressionAttributeValues: {
                                ':v': objKey
                            },
                            UpdateExpression: 'set #a = :v',
                        };

                        setTimeout(function () { 

                            docClient.update(params, function (err, data) {
                                if (err) console.log(err);
                                else console.log(data);
                            })

                        }, 1500);

                        document.getElementById("addimg").style.display = "none";
                        document.getElementById("profileLink").style.display = "block";
                        document.getElementById("profileLink").innerHTML += "View your profile <a href='../profile/?name=" + fullName + "'>  <i class='fa fa-2x fa-arrow-circle-right' aria-hidden='true'></i></a>";


                    }
                });
            } else {
                
                console.log("No file to load...");
            }
        }, false);

        window.fbAsyncInit = function () {
            FB.init({ appId: appId });



            FB.getLoginStatus(function (response) {
                if (response.authResponse) {
                    AWS.config.credentials = new AWS.WebIdentityCredentials({ //WIF
                        RoleArn: roleArn,
                        ProviderId: 'graph.facebook.com',
                        WebIdentityToken: response.authResponse.accessToken
                    });

                    fbUserId = response.authResponse.userID;
                    username = response.authResponse.name;
                    AWS.config.region = 'us-west-2'; //VERIFY YOUR S3 BUCKET REGION
                    
                    bucket = new AWS.S3({
                        params: {
                            Bucket: bucketName
                        }
                    });

                    bucket.config.credentials = new AWS.WebIdentityCredentials({ //WIF
                        ProviderId: 'graph.facebook.com',
                        RoleArn: roleArn,
                        WebIdentityToken: response.authResponse.accessToken
                    });

                }
                else {
                    console.log("Issue logging in");
                }

                // Load the FB JS SDK asynchronously
                (function (d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) { return; }
                    js = d.createElement(s); js.id = id;
                    js.src = "https://connect.facebook.net/en_US/all.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
            })


            var url = window.location.href;
            console.log("url = " + url);

            var x = breakUpURLParameters(url);
            console.log(x.search);
            console.log("1  = " + x.search.name); //please refer to http://www.w3schools.com/jsref/jsref_map.asp for example code
            document.getElementById("fullName").value = x.search.name + " " + x.search.last;
            document.getElementById("email").value = x.search.email;
        }
    </script>



	
</body>

</html>
